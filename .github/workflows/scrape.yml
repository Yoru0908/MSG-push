name: å‚é“æ¶ˆæ¯æŠ“å–æ¨é€

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯15åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '*/15 * * * *'  # æ¯15åˆ†é’Ÿ
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # Pushåˆ°mainåˆ†æ”¯æ—¶ä¹Ÿæ‰§è¡Œï¼ˆç”¨äºæµ‹è¯•ï¼‰
  push:
    branches:
      - main

jobs:
  scrape-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # éœ€è¦å®Œæ•´å†å²è®°å½•æ¥commit hashæ–‡ä»¶
          fetch-depth: 0
      
      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: ğŸ­ å®‰è£… Playwright
        run: npx playwright install --with-deps chromium
      
      - name: ğŸ” æ¢å¤è®¤è¯æ•°æ®
        run: |
          mkdir -p data
          # ä»GitHub Secretsæ¢å¤cookiesï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ ! -z "${{ secrets.HINATAZAKA_COOKIES }}" ]; then
            echo '${{ secrets.HINATAZAKA_COOKIES }}' > data/cookies-hinatazaka46.json
          fi
          if [ ! -z "${{ secrets.SAKURAZAKA_COOKIES }}" ]; then
            echo '${{ secrets.SAKURAZAKA_COOKIES }}' > data/cookies-sakurazaka46.json
          fi
      
      - name: ğŸš€ æ‰§è¡ŒæŠ“å–
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          HINATAZAKA_EMAIL: ${{ secrets.HINATAZAKA_EMAIL }}
          HINATAZAKA_PASSWORD: ${{ secrets.HINATAZAKA_PASSWORD }}
          SAKURAZAKA_EMAIL: ${{ secrets.SAKURAZAKA_EMAIL }}
          SAKURAZAKA_PASSWORD: ${{ secrets.SAKURAZAKA_PASSWORD }}
        run: node src/index.js
      
      - name: ğŸ’¾ ä¿å­˜è®¤è¯æ•°æ®
        if: always()
        run: |
          # æäº¤æ›´æ–°çš„hashæ–‡ä»¶å’Œcookies
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add data/*.txt data/*.json 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ æ— éœ€æäº¤"
          else
            git commit -m "chore: æ›´æ–°æŠ“å–æ•°æ® [skip ci]"
            git push
          fi
      
      - name: ğŸ“Š ä¸Šä¼ æ—¥å¿—
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: scrape-logs
          path: |
            data/
            *.log
          retention-days: 7
