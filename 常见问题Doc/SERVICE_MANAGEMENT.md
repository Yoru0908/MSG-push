# MSG æ¨é€æœåŠ¡ç®¡ç†æŒ‡å—

## æœåŠ¡æ¶æ„

MSG æ¨é€æœåŠ¡ç”± **PM2** è¿›ç¨‹ç®¡ç†å™¨æ‰˜ç®¡ï¼Œä¸æ˜¯é€šè¿‡ nohup ç›´æ¥è¿è¡Œã€‚

```
PM2 God Daemon
â””â”€â”€ msg-pusher (id: 2)
â””â”€â”€ blog-push (id: 1)
```

## å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 list

# é‡å¯æœåŠ¡ï¼ˆæ¨èï¼‰
pm2 restart msg-pusher --update-env

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs msg-pusher

# æŸ¥çœ‹æœ€è¿‘30è¡Œæ—¥å¿—
pm2 logs msg-pusher --lines 30 --nostream

# åœæ­¢æœåŠ¡
pm2 stop msg-pusher

# å¯åŠ¨æœåŠ¡
pm2 start msg-pusher
```

## âš ï¸ å¸¸è§é—®é¢˜ï¼šé‡å¤æ¨é€

### é—®é¢˜æè¿°
åŒä¸€æ¡æ¶ˆæ¯è¢«æ¨é€å¤šæ¬¡ï¼ˆ2-5æ¬¡ï¼‰ã€‚

### åŸå› 
1. **å­¤å„¿è¿›ç¨‹**ï¼šä¹‹å‰ä½¿ç”¨ `nohup node src/main.js &` å¯åŠ¨çš„è¿›ç¨‹æ²¡æœ‰è¢«æ¸…ç†
2. **PM2 + æ‰‹åŠ¨å¯åŠ¨æ··ç”¨**ï¼šPM2 æ‰˜ç®¡çš„è¿›ç¨‹å’Œæ‰‹åŠ¨å¯åŠ¨çš„è¿›ç¨‹åŒæ—¶è¿è¡Œ

### è¯Šæ–­æ–¹æ³•
```bash
# æ–¹æ³•1ï¼šæŸ¥çœ‹æ‰€æœ‰ node msg-pusher ç›¸å…³è¿›ç¨‹
ps aux | grep -E "node.*msg-pusher|node.*main.js" | grep -v grep

# æ–¹æ³•2ï¼šåªçœ‹ PM2 çŠ¶æ€ï¼ˆå¯èƒ½æ¼æ‰å­¤å„¿è¿›ç¨‹ï¼‰
pm2 list

# æ­£ç¡®åšæ³•ï¼šä¸¤ä¸ªéƒ½æ£€æŸ¥
# PM2 åº”è¯¥åªæ˜¾ç¤º 1 ä¸ª msg-pusher
# ps aux åº”è¯¥åªæ˜¾ç¤º 1 ä¸ªç›¸å…³è¿›ç¨‹
```

### è§£å†³æ–¹æ³•
```bash
# 1. æŸ¥æ‰¾æ‰€æœ‰ç›¸å…³è¿›ç¨‹
ps aux | grep -E "node.*main.js" | grep -v grep | grep -v blog-push

# 2. æ€æ­»ä¸æ˜¯ PM2 æ‰˜ç®¡çš„å­¤å„¿è¿›ç¨‹
# ï¼ˆPM2 æ‰˜ç®¡çš„è¿›ç¨‹è·¯å¾„æ˜¯ /opt/msg-pusher/src/main.jsï¼‰
kill -9 <éPM2æ‰˜ç®¡çš„PID>

# 3. æˆ–è€…ä¸€æ¬¡æ€§æ¸…ç†æ‰€æœ‰è¿›ç¨‹ï¼ˆPM2 ä¼šè‡ªåŠ¨é‡å¯æ‰˜ç®¡çš„è¿›ç¨‹ï¼‰
pkill -9 -f "node.*main.js"
# æ³¨æ„ï¼šè¿™ä¼šæ€æ­»æ‰€æœ‰ node main.js è¿›ç¨‹ï¼ŒåŒ…æ‹¬ blog-push

# 4. ç¡®è®¤åªå‰©ä¸€ä¸ªè¿›ç¨‹
ps aux | grep -E "node.*msg-pusher" | grep -v grep | wc -l
# åº”è¯¥è¿”å› 1
```

### 2026-02-09 æ¡ˆä¾‹
å‘ç° **4 ä¸ªå­¤å„¿è¿›ç¨‹** ä¸ PM2 è¿›ç¨‹åŒæ—¶è¿è¡Œï¼š
```
PID 1090768 - å­¤å„¿è¿›ç¨‹ (Feb08)
PID 1154800 - å­¤å„¿è¿›ç¨‹ (Feb08)
PID 1156164 - å­¤å„¿è¿›ç¨‹ (Feb08)  
PID 1250525 - å­¤å„¿è¿›ç¨‹ (00:38)
PID 1255131 - PM2 æ‰˜ç®¡ âœ…
```
å…± 5 ä¸ªè¿›ç¨‹å¯¼è‡´æ¶ˆæ¯è¢«æ¨é€ 5 æ¬¡ã€‚

### é¢„é˜²æªæ–½
**æ°¸è¿œä¸è¦ä½¿ç”¨**ï¼š
```bash
# âŒ é”™è¯¯ï¼šä¼šåˆ›å»ºé¢å¤–çš„è¿›ç¨‹å®ä¾‹
nohup node src/main.js > /tmp/msg-pusher.log 2>&1 &

# âŒ é”™è¯¯ï¼špkill ååˆç”¨ nohup æ‰‹åŠ¨å¯åŠ¨
pkill -f "node.*msg-pusher"
nohup node src/main.js > /tmp/msg-pusher.log 2>&1 &
```

**æ­£ç¡®åšæ³•**ï¼š
```bash
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ PM2 é‡å¯
pm2 restart msg-pusher --update-env

# âœ… å¦‚æœéœ€è¦é‡æ–°åŠ è½½ä»£ç 
pm2 reload msg-pusher
```

## è®¤è¯é€»è¾‘

æœåŠ¡ä½¿ç”¨**æ··åˆè®¤è¯æ¨¡å¼**ï¼š

1. **é¦–å…ˆ**å°è¯• Google OAuth è®¤è¯
2. **å¦‚æœå¤±è´¥**ï¼Œå›é€€åˆ° APP Token åˆ·æ–° (`/v2/update_token`)

å½“å‰çŠ¶æ€ï¼ˆ2026-02-09ï¼‰ï¼š

| ç«™ç‚¹ | è®¤è¯æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| ä¹ƒæœ¨å‚46 | Google OAuth | Google refresh_token æœ‰æ•ˆ |
| æ«»å‚46 | Google OAuth | Google refresh_token æœ‰æ•ˆ |
| æ—¥å‘å‚46 | APP Token | Google token è¿‡æœŸï¼Œä½¿ç”¨ APP Token |

## æ—¥å¿—ä½ç½®

- **PM2 æ—¥å¿—**ï¼ˆæ¨èæŸ¥çœ‹ï¼‰: 
  - `~/.pm2/logs/msg-pusher-out.log`
  - `~/.pm2/logs/msg-pusher-error.log`
- æ—§æ—¥å¿—ï¼ˆå¦‚æœ‰ï¼‰: `/tmp/msg-pusher.log`

## é…ç½®çƒ­åŠ è½½

æœåŠ¡æ”¯æŒé…ç½®çƒ­åŠ è½½ï¼Œä¿®æ”¹ `.env` æˆ– `push-config.js` åä¼šè‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯ã€‚æ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºï¼š
```
ğŸ”„ é…ç½®å·²çƒ­åŠ è½½
```
